<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx 通关 | 云旭泉的博客</title>
    <meta name="generator" content="VuePress 1.5.1">
    
    <meta name="description" content="专注全栈技术分享">
    <link rel="preload" href="/blog/assets/css/0.styles.39c0576a.css" as="style"><link rel="preload" href="/blog/assets/js/app.9b8d30b8.js" as="script"><link rel="preload" href="/blog/assets/js/2.0a93f5dd.js" as="script"><link rel="preload" href="/blog/assets/js/27.d3f4e021.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f798a2d8.js"><link rel="prefetch" href="/blog/assets/js/11.d54a8208.js"><link rel="prefetch" href="/blog/assets/js/12.e0a98157.js"><link rel="prefetch" href="/blog/assets/js/13.87c877fd.js"><link rel="prefetch" href="/blog/assets/js/14.d7c59895.js"><link rel="prefetch" href="/blog/assets/js/15.6277aecb.js"><link rel="prefetch" href="/blog/assets/js/16.01e8b1ad.js"><link rel="prefetch" href="/blog/assets/js/17.712b9225.js"><link rel="prefetch" href="/blog/assets/js/18.522ef26f.js"><link rel="prefetch" href="/blog/assets/js/19.5445ecf3.js"><link rel="prefetch" href="/blog/assets/js/20.47f43b7b.js"><link rel="prefetch" href="/blog/assets/js/21.9f8c275f.js"><link rel="prefetch" href="/blog/assets/js/22.a756c658.js"><link rel="prefetch" href="/blog/assets/js/23.b4bcee6c.js"><link rel="prefetch" href="/blog/assets/js/24.8ec49f71.js"><link rel="prefetch" href="/blog/assets/js/25.775adcca.js"><link rel="prefetch" href="/blog/assets/js/26.ee451341.js"><link rel="prefetch" href="/blog/assets/js/28.b9c8da82.js"><link rel="prefetch" href="/blog/assets/js/29.d8e3f233.js"><link rel="prefetch" href="/blog/assets/js/3.ffb23f29.js"><link rel="prefetch" href="/blog/assets/js/30.931a269f.js"><link rel="prefetch" href="/blog/assets/js/31.0125aec6.js"><link rel="prefetch" href="/blog/assets/js/32.bf0f1052.js"><link rel="prefetch" href="/blog/assets/js/33.1b679a21.js"><link rel="prefetch" href="/blog/assets/js/34.b5543fb7.js"><link rel="prefetch" href="/blog/assets/js/35.0bfad671.js"><link rel="prefetch" href="/blog/assets/js/36.de9fee6a.js"><link rel="prefetch" href="/blog/assets/js/37.eaaf3327.js"><link rel="prefetch" href="/blog/assets/js/38.1e0f9389.js"><link rel="prefetch" href="/blog/assets/js/39.5ec5bcd4.js"><link rel="prefetch" href="/blog/assets/js/4.a0155084.js"><link rel="prefetch" href="/blog/assets/js/40.a851c68a.js"><link rel="prefetch" href="/blog/assets/js/41.ce3ebcca.js"><link rel="prefetch" href="/blog/assets/js/42.d7a988ab.js"><link rel="prefetch" href="/blog/assets/js/43.34c1ed44.js"><link rel="prefetch" href="/blog/assets/js/44.8f6680b9.js"><link rel="prefetch" href="/blog/assets/js/45.0fbc2ae1.js"><link rel="prefetch" href="/blog/assets/js/46.fd04d742.js"><link rel="prefetch" href="/blog/assets/js/47.1ec9c3da.js"><link rel="prefetch" href="/blog/assets/js/48.081d87ac.js"><link rel="prefetch" href="/blog/assets/js/49.eb09b8f9.js"><link rel="prefetch" href="/blog/assets/js/5.e569c75c.js"><link rel="prefetch" href="/blog/assets/js/50.7d1733bd.js"><link rel="prefetch" href="/blog/assets/js/51.0c621372.js"><link rel="prefetch" href="/blog/assets/js/52.63757a91.js"><link rel="prefetch" href="/blog/assets/js/53.6d33b67a.js"><link rel="prefetch" href="/blog/assets/js/54.d6014ffc.js"><link rel="prefetch" href="/blog/assets/js/6.eb41542c.js"><link rel="prefetch" href="/blog/assets/js/7.f36d4014.js"><link rel="prefetch" href="/blog/assets/js/8.5980153c.js"><link rel="prefetch" href="/blog/assets/js/9.cadab512.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.39c0576a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">云旭泉的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="/blog/rearend/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试问题
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link router-link-active">
  其它
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/blog/node/" class="nav-link">
  node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/web/react/" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/blog/web/js/" class="nav-link">
  js
</a></li></ul></div></div><div class="nav-item"><a href="/blog/rearend/" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link">
  面试问题
</a></div><div class="nav-item"><a href="/blog/other/" class="nav-link router-link-active">
  其它
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/other/" aria-current="page" class="sidebar-link">mac 上彻底卸载 Intelj</a></li><li><a href="/blog/other/email.html" class="sidebar-link">web 开发邮件模板</a></li><li><a href="/blog/other/nginx.html" aria-current="page" class="active sidebar-link">nginx 通关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#主配置文件" class="sidebar-link">主配置文件</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#日志文件" class="sidebar-link">日志文件</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#优先级" class="sidebar-link">优先级</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#location-匹配规则" class="sidebar-link">location 匹配规则</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#http-access-module" class="sidebar-link">httpaccessmodule</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#压缩静态资源" class="sidebar-link">压缩静态资源</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#设置过期时间" class="sidebar-link">设置过期时间</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#正向代理？" class="sidebar-link">正向代理？</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#反向代理？" class="sidebar-link">反向代理？</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#rewrite-语法" class="sidebar-link">rewrite 语法</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#rewrite-优先级" class="sidebar-link">rewrite 优先级</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#使用模块" class="sidebar-link">使用模块</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#使用模块-2" class="sidebar-link">使用模块</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#https-配置" class="sidebar-link">https 配置</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#https-服务优化" class="sidebar-link">https 服务优化</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#nginx-lua" class="sidebar-link">nginx+ Lua</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#lua-基础语法" class="sidebar-link">Lua 基础语法</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#根据-ip-进行不同内容的访问" class="sidebar-link">根据 ip 进行不同内容的访问</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#ab-接口压力测试工具" class="sidebar-link">ab 接口压力测试工具</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#cpu-亲和" class="sidebar-link">cpu 亲和</a></li><li class="sidebar-sub-header"><a href="/blog/other/nginx.html#常见的攻击手段" class="sidebar-link">常见的攻击手段</a></li></ul></li><li><a href="/blog/other/github贡献代码.html" class="sidebar-link">GitHub 贡献代码</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-通关"><a href="#nginx-通关" class="header-anchor">#</a> nginx 通关</h1> <h1 id="什么是-nginx？"><a href="#什么是-nginx？" class="header-anchor">#</a> 什么是 nginx？</h1> <p>nginx 是一个开源可靠的 HTTP 中间件代理服务。</p> <h1 id="配置目录"><a href="#配置目录" class="header-anchor">#</a> 配置目录</h1> <h2 id="主配置文件"><a href="#主配置文件" class="header-anchor">#</a> 主配置文件</h2> <p>/etc/nginx/nginx.conf <br>
配置文件基本结构：
<img src="https://user-gold-cdn.xitu.io/2019/10/23/16df76f566fe407b?w=1516&amp;h=668&amp;f=png&amp;s=47231" alt=""></p> <h1 id="nginx-开启，关闭，重启"><a href="#nginx-开启，关闭，重启" class="header-anchor">#</a> nginx 开启，关闭，重启</h1> <p>开启 systemctl start nginx
关闭 nginx -s stop
重启，nginx -s reload （这个一般是在修改配置文件后，先用 nginx -t 检查配置语法是否正确后，再用 nginx -s reload 平滑重启）</p> <h2 id="日志文件"><a href="#日志文件" class="header-anchor">#</a> 日志文件</h2> <p>/var/log/nginx</p> <h1 id="发生错误的时候查找方法"><a href="#发生错误的时候查找方法" class="header-anchor">#</a> 发生错误的时候查找方法</h1> <p>最重要的就是错误日志，错误日志，错误日志，当发生错误的时候，首先第一要想到去查看错误日志，查看发生错误的原因。</p> <ul><li>1，首先查看错误日志
tail -n 10 /var/log/nginx/error.log</li> <li>2，找到错误原因，修改配置文件
/etc/nginx/conf.d/default.conf</li> <li>3，查看修改的错误命令是否争取
nginx -t</li> <li>4，平滑重启
nginx -s reload</li></ul> <h1 id="server-name"><a href="#server-name" class="header-anchor">#</a> server_name</h1> <h2 id="优先级"><a href="#优先级" class="header-anchor">#</a> 优先级</h2> <p>1，当在多个 serve 中匹配了相同的 server_name
最先出现的优先级是最高的。</p> <h1 id="location"><a href="#location" class="header-anchor">#</a> location</h1> <h2 id="location-匹配规则"><a href="#location-匹配规则" class="header-anchor">#</a> location 匹配规则</h2> <ul><li>1 = 表示精确匹配。只有请求的 url 路径与后面的字符串完全相等时，才会命中。</li> <li>2 ~ 表示该规则是使用正则定义的，区分大小写。</li> <li>3 ~* 表示该规则是使用正则定义的，不区分大小写。</li> <li>4 ^~ 表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找。
匹配顺序</li> <li>1 如果匹配到 = ， 也就是精确匹配到 url，则返回</li> <li>2 如果匹配到^~,则返回，并且不会想下匹配。这里我曾经遇到过在同一服务器上同时部署两个 react 单页项目的时候，一个 react A 项目放在/home 目录下，一个 react B 项目放在/codsse 目录下，因为写了如下规则</li></ul> <div class="language- extra-class"><pre class="language-text"><code>^~ /codsse {
    ...
}
</code></pre></div><p>导致当 url 是/codesse/的时候，可以匹配到 B 项目的 index.html,但是同时在 B 中 index.html 中的 js 也匹配到了 B 项目的 index.html,所以导致形成了一个死循环。</p> <ul><li>3 接下来匹配正则表达式的，~ 或者~*的，如果匹配到则返回</li> <li>4 最后都没匹配到，则返回最大匹配的或者 404</li> <li>5 = &gt; ^~ &gt; ~/~* 优先级</li></ul> <h1 id="try-files"><a href="#try-files" class="header-anchor">#</a> try_files</h1> <p>try_files 试图寻找的文件</p> <h1 id="alias-与-root-的区别"><a href="#alias-与-root-的区别" class="header-anchor">#</a> alias 与 root 的区别</h1> <p>root 会把匹配到 location 连在一起去访问
比如有以下配置</p> <div class="language-js extra-class"><pre class="language-js"><code>location <span class="token operator">/</span>cat <span class="token punctuation">{</span>
    root <span class="token operator">/</span>cat<span class="token operator">/</span>imgs<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当访问 xx/cat/a.png 的时候，实际上是到 /cat/imgs/cat/a.png 中去寻找
当 alias 是/cat/imgs 的时候，同样的网址，实际上到/cat/imgs/a.png 中去寻找</p> <h1 id="nginx-的访问控制"><a href="#nginx-的访问控制" class="header-anchor">#</a> nginx 的访问控制</h1> <h2 id="http-access-module"><a href="#http-access-module" class="header-anchor">#</a> http_access_module</h2> <p>deny 拒绝访问<br>
allow 可以访问</p> <h1 id="作为静态资源服务器"><a href="#作为静态资源服务器" class="header-anchor">#</a> 作为静态资源服务器</h1> <h2 id="压缩静态资源"><a href="#压缩静态资源" class="header-anchor">#</a> 压缩静态资源</h2> <p>1， gzip：on<br>
        gzip_comp_level: 2 (压缩级别)<br></p> <h2 id="设置过期时间"><a href="#设置过期时间" class="header-anchor">#</a> 设置过期时间</h2> <p>一般浏览器首先会检查 max-age，如果过期，则会发送 etag 和 Last-Modified 到服务器验证
1， 设置过期时间<br>
       expires</p> <h1 id="正向代理和反向代理"><a href="#正向代理和反向代理" class="header-anchor">#</a> 正向代理和反向代理</h1> <h2 id="正向代理？"><a href="#正向代理？" class="header-anchor">#</a> 正向代理？</h2> <p>正向代理就是代理客户端发起请求，比如我们经常使用的 vpn</p> <h2 id="反向代理？"><a href="#反向代理？" class="header-anchor">#</a> 反向代理？</h2> <p>就是在服务器端进行代理，比如你访问一个域名，并不知道真正的实际资源是否通过 nginx 给代理到哪里去了。</p> <h1 id="跨域访问"><a href="#跨域访问" class="header-anchor">#</a> 跨域访问</h1> <p>设置可以 nginx 允许可以跨域访问</p> <div class="language- extra-class"><pre class="language-text"><code>location /sddss/ {
       proxy_redirect off; # 关闭重定向
       add_header Access-Control-Allow-Origin *;
   }
</code></pre></div><h1 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h1> <p>所谓的负载均衡其实就是通过 nginx 把请求转发到不同的服务器上面去。
每个服务可以配置一些参数，比如 weight 权重，比如 max_fails 等
负载均衡也可以选择不同的算法，比如轮询，比如 ip—hash 算法和 url—hash 算法等</p> <div class="language- extra-class"><pre class="language-text"><code>upsteam ii {
    serve 1;
    serve 2;
}
server {
    location / {
        proxy_pass ii;
        include proxy_params;
    }
}
</code></pre></div><h1 id="nginx-作为缓存服务器"><a href="#nginx-作为缓存服务器" class="header-anchor">#</a> nginx 作为缓存服务器</h1> <p>nginx 作为中间缓存，使用 proxy_cache_path</p> <h1 id="nginx-重定向-url"><a href="#nginx-重定向-url" class="header-anchor">#</a> nginx 重定向 url</h1> <p>可以通过 rewrite 根据正则匹配，把匹配到的 url 重定向到别的 url 中去</p> <h2 id="rewrite-语法"><a href="#rewrite-语法" class="header-anchor">#</a> rewrite 语法</h2> <p>rewrite 正则 flag <br>
flag 包括 break，last,redirect，permanent
break 会直接去查找<br>
而 last 相当于会继续向下匹配<br>
rediect 临时重定向<br>
permanent 永久重定向</p> <h2 id="rewrite-优先级"><a href="#rewrite-优先级" class="header-anchor">#</a> rewrite 优先级</h2> <p>sever 中的 rewrite 规则 &gt; location 中的 rewrite 规则</p> <h1 id="nginx-链接周期限制"><a href="#nginx-链接周期限制" class="header-anchor">#</a> nginx 链接周期限制</h1> <h2 id="使用模块"><a href="#使用模块" class="header-anchor">#</a> 使用模块</h2> <p>secure_link_module
原理就是首先 nginx 根据一些信息返回下载链接包括 md5 和 expries，然后下载的时候，nginx 在进行验证 md5 和过期时间。
返回链接如下：
/download?mad5=dsdsd&amp;expries=112233222</p> <div class="language-js extra-class"><pre class="language-js"><code>location <span class="token operator">~</span> <span class="token punctuation">{</span>
   secure_link
   secure_link_md5
<span class="token punctuation">}</span>
</code></pre></div><h1 id="nginx-区分国内外-ip"><a href="#nginx-区分国内外-ip" class="header-anchor">#</a> nginx 区分国内外 ip</h1> <h2 id="使用模块-2"><a href="#使用模块-2" class="header-anchor">#</a> 使用模块</h2> <p>http_geoip_module
可以根据访问的 ip 是否是国内 ip，来进行限制访问</p> <div class="language-js extra-class"><pre class="language-js"><code>location <span class="token operator">/</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>$geoip_country_code <span class="token operator">!=</span> <span class="token constant">CN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">403</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="nginx-https"><a href="#nginx-https" class="header-anchor">#</a> nginx https</h1> <h2 id="https-配置"><a href="#https-配置" class="header-anchor">#</a> https 配置</h2> <p>*1 安装 openssl http_ssl_module
*2 生成 CA 证书
*3 配置</p> <div class="language- extra-class"><pre class="language-text"><code>server {
    listen      443;
    server_name www.onedns.net;
    ssl         on;
    ssl_certificate     /etc/nginx/ssl/111net.pem;
    ssl_certificate_key /etc/nginx/ssl/2222.key;
    ssl_protocols       Tddsdss;
    ssl_ciphers         dddssdss;
</code></pre></div><h2 id="https-服务优化"><a href="#https-服务优化" class="header-anchor">#</a> https 服务优化</h2> <p>*1 激活 keepalive 长链接
*2 激活 ssl cache 缓存</p> <h2 id="nginx-lua"><a href="#nginx-lua" class="header-anchor">#</a> nginx+ Lua</h2> <h2 id="lua-基础语法"><a href="#lua-基础语法" class="header-anchor">#</a> Lua 基础语法</h2> <ul><li>1 ~= 表示不等于</li> <li>2 字符串拼接 ..</li></ul> <h2 id="根据-ip-进行不同内容的访问"><a href="#根据-ip-进行不同内容的访问" class="header-anchor">#</a> 根据 ip 进行不同内容的访问</h2> <p>基本原理： 当用户访问的时候，nginx 获得用户的 ip，然后通过 lua 去访问 ip 数据库，然后让不同的 ip 访问不同的内容。</p> <div class="language-js extra-class"><pre class="language-js"><code>location <span class="token operator">/</span> <span class="token punctuation">{</span>
    default_type <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span>
    content_by_lua_file <span class="token operator">/</span>opt<span class="token operator">/</span><span class="token keyword">as</span><span class="token punctuation">.</span>lua<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="nginx-性能优化"><a href="#nginx-性能优化" class="header-anchor">#</a> nginx 性能优化</h1> <h2 id="ab-接口压力测试工具"><a href="#ab-接口压力测试工具" class="header-anchor">#</a> ab 接口压力测试工具</h2> <p>ab -n 2000 -c 2 http://127.0.0.1</p> <h2 id="cpu-亲和"><a href="#cpu-亲和" class="header-anchor">#</a> cpu 亲和</h2> <p>设置 worker process 为 cpu 核数</p> <h1 id="nginx-安全"><a href="#nginx-安全" class="header-anchor">#</a> nginx 安全</h1> <h2 id="常见的攻击手段"><a href="#常见的攻击手段" class="header-anchor">#</a> 常见的攻击手段</h2> <ul><li>1 密码撞库</li> <li>2 文件上传漏洞</li> <li>3 sql 注入</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/other/email.html" class="prev">
        web 开发邮件模板
      </a></span> <span class="next"><a href="/blog/other/github贡献代码.html">
        GitHub 贡献代码
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.9b8d30b8.js" defer></script><script src="/blog/assets/js/2.0a93f5dd.js" defer></script><script src="/blog/assets/js/27.d3f4e021.js" defer></script>
  </body>
</html>
